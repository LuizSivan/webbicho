<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
		xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
		xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.29.xsd"
		objectQuotingStrategy="QUOTE_ONLY_RESERVED_WORDS">
	<!-- Creating Users Table -->
	<changeSet id="1739636643888-1"
						 author="Luiz Silva">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="users"/>
			</not>
		</preConditions>
		
		<createTable tableName="users">
			<column name="uuid"
							type="UUID">
				<constraints nullable="false"
										 primaryKey="true"
										 primaryKeyName="pk_users"/>
			</column>
			<column name="created_by"
							type="UUID"/>
			<column name="updated_by"
							type="UUID"/>
			<column name="created_at"
							type="DATETIME">
				<constraints nullable="false"/>
			</column>
			<column name="updated_at"
							type="DATETIME"/>
			<column name="deleted_at"
							type="DATETIME"/>
			<column name="username"
							type="VARCHAR(30)">
				<constraints nullable="false"/>
			</column>
			<column name="exibition_name"
							type="VARCHAR(60)">
				<constraints nullable="false"/>
			</column>
			<column name="email"
							type="VARCHAR(320)">
				<constraints nullable="false"/>
			</column>
			<column name="about"
							type="TEXT"/>
			<column name="role"
							type="VARCHAR(255)">
				<constraints nullable="false"/>
			</column>
			<column name="avatar"
							type="TEXT"/>
		</createTable>
		
		<addUniqueConstraint columnNames="email"
												 constraintName="uc_users_email"
												 tableName="users"/>
		
		<addUniqueConstraint columnNames="username"
												 constraintName="uc_users_username"
												 tableName="users"/>
		
		<createIndex indexName="idx_user"
								 tableName="users">
			<column name="username"/>
			<column name="email"/>
			<column name="role"/>
		</createIndex>
		
		<addForeignKeyConstraint baseColumnNames="updated_by"
														 baseTableName="users"
														 constraintName="FK_USERS_ON_UPDATED_BY"
														 referencedColumnNames="uuid"
														 referencedTableName="users"/>
		
		<addForeignKeyConstraint baseColumnNames="created_by"
														 baseTableName="users"
														 constraintName="FK_USERS_ON_CREATED_BY"
														 referencedColumnNames="uuid"
														 referencedTableName="users"/>
	</changeSet>
	
	<!-- Creating Posts Table -->
	<changeSet id="1739636643888-2"
						 author="Luiz Silva">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="posts"/>
			</not>
		</preConditions>
		
		<createTable tableName="posts">
			<column name="uuid"
							type="UUID">
				<constraints nullable="false"
										 primaryKey="true"
										 primaryKeyName="pk_posts"/>
			</column>
			<column name="created_by"
							type="UUID"/>
			<column name="updated_by"
							type="UUID"/>
			<column name="created_at"
							type="DATETIME">
				<constraints nullable="false"/>
			</column>
			<column name="updated_at"
							type="DATETIME"/>
			<column name="deleted_at"
							type="DATETIME"/>
			<column name="content"
							type="TEXT">
				<constraints nullable="false"/>
			</column>
			<column name="user_uuid"
							type="UUID">
				<constraints nullable="false"/>
			</column>
		</createTable>
		
		<addForeignKeyConstraint baseColumnNames="created_by"
														 baseTableName="posts"
														 constraintName="FK_POSTS_ON_CREATED_BY"
														 referencedColumnNames="uuid"
														 referencedTableName="users"/>
		
		<addForeignKeyConstraint baseColumnNames="updated_by"
														 baseTableName="posts"
														 constraintName="FK_POSTS_ON_UPDATED_BY"
														 referencedColumnNames="uuid"
														 referencedTableName="users"/>
		
		<addForeignKeyConstraint baseColumnNames="user_uuid"
														 baseTableName="posts"
														 constraintName="FK_POSTS_ON_USER_UUID"
														 referencedColumnNames="uuid"
														 referencedTableName="users"
														 onDelete="CASCADE"/>
	</changeSet>
	
	<!-- Creating Comments Table-->
	<changeSet id="1739636643888-3"
						 author="Luiz Silva">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="comments"/>
			</not>
		</preConditions>
		
		<createTable tableName="comments">
			<column name="uuid"
							type="UUID">
				<constraints nullable="false"
										 primaryKey="true"
										 primaryKeyName="pk_comments"/>
			</column>
			<column name="created_by"
							type="UUID"/>
			<column name="updated_by"
							type="UUID"/>
			<column name="created_at"
							type="DATETIME">
				<constraints nullable="false"/>
			</column>
			<column name="updated_at"
							type="DATETIME"/>
			<column name="deleted_at"
							type="DATETIME"/>
			<column name="content"
							type="TEXT">
				<constraints nullable="false"/>
			</column>
			<column name="user_uuid"
							type="UUID">
				<constraints nullable="false"/>
			</column>
			<column name="post_uuid"
							type="UUID"/>
			<column name="parent_uuid"
							type="UUID"/>
		</createTable>
		
		<sql>
			ALTER TABLE comments
				ADD CONSTRAINT CK_COMMENTS_PARENT_OR_POST_UUID
					CHECK (COALESCE(post_uuid, parent_uuid) IS NOT NULL);
		</sql>
		
		<addForeignKeyConstraint baseColumnNames="created_by"
														 baseTableName="comments"
														 constraintName="FK_COMMENTS_ON_CREATED_BY"
														 referencedColumnNames="uuid"
														 referencedTableName="users"/>
		
		<addForeignKeyConstraint baseColumnNames="updated_by"
														 baseTableName="comments"
														 constraintName="FK_COMMENTS_ON_UPDATED_BY"
														 referencedColumnNames="uuid"
														 referencedTableName="users"/>
		
		<addForeignKeyConstraint baseColumnNames="user_uuid"
														 baseTableName="comments"
														 constraintName="FK_COMMENTS_ON_USER_UUID"
														 referencedColumnNames="uuid"
														 onDelete="CASCADE"
														 referencedTableName="users"/>
		
		<addForeignKeyConstraint baseColumnNames="post_uuid"
														 baseTableName="comments"
														 constraintName="FK_COMMENTS_ON_POST_UUID"
														 referencedColumnNames="uuid"
														 onDelete="CASCADE"
														 referencedTableName="posts"/>
		
		<addForeignKeyConstraint baseColumnNames="parent_uuid"
														 baseTableName="comments"
														 constraintName="FK_COMMENTS_ON_PARENT_UUID"
														 referencedColumnNames="uuid"
														 onDelete="CASCADE"
														 referencedTableName="comments"/>
	</changeSet>
</databaseChangeLog>
